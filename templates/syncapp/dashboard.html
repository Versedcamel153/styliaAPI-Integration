{% extends "base.html" %}

{% block title %}Dashboard · Stylia ↔ Shopify Sync{% endblock %}

{% block content %}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div class="bg-white p-4 rounded shadow">
            <div class="text-gray-500 text-sm">Total</div>
            <div class="text-2xl font-semibold">{{ stats.total }}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
            <div class="text-gray-500 text-sm">Pushed</div>
            <div class="text-2xl font-semibold text-green-600">{{ stats.pushed }}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
            <div class="text-gray-500 text-sm">Pending</div>
            <div class="text-2xl font-semibold text-blue-600">{{ stats.pending }}</div>
        </div>
        <div class="bg-white p-4 rounded shadow">
            <div class="text-gray-500 text-sm">Failed</div>
            <div class="text-2xl font-semibold text-red-600">{{ stats.failed }}</div>
        </div>
        <!-- <div class="bg-white p-4 rounded shadow">
            <div class="text-gray-500 text-sm">Deleted</div>
            <div class="text-2xl font-semibold text-gray-600">{{ stats.deleted }}</div>
        </div> -->

        <script>
            async function deleteProduct(id) {
                if (!confirm('Are you sure you want to delete this product from the sync list? This will not delete it from Shopify or Stylia.')) return;
                try {
                    const res = await fetch(`/api/products/${id}/delete/`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        // Refresh to show the updated list
                        window.location.reload();
                    } else {
                        alert('Failed: ' + (data.error || 'unknown'));
                    }
                } catch (e) {
                    alert('Request failed: ' + e.message);
                }
            }
        </script>
    </div>

    <div class="flex items-center gap-2">
        <label for="show" class="text-sm text-gray-700">Show:</label>
        <select id="show" onchange="onFilterChange()"
            class="border select border-gray-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all" {% if show == 'all' %}selected{% endif %}>All</option>
            <option value="pushed" {% if show == 'pushed' %}selected{% endif %}>Pushed</option>
            <option value="pending" {% if show == 'pending' %}selected{% endif %}>Pending</option>
            <option value="failed" {% if show == 'failed' %}selected{% endif %}>Failed</option>
            <option value="deleted" {% if show == 'deleted' %}selected{% endif %}>Deleted</option>
        </select>
        <button onclick="triggerSync()" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Run Sync
            Now</button>
        <button onclick="deleteAllPushed()"
            class="ml-2 bg-red-600 hover:bg-red-700 text-white rounded px-4 py-2 text-sm">Delete All Pushed</button>
        <!-- {% if shopify_store_url %}
        <a href="/shopify/install/?shop={{ shopify_store_url }}"
            class="ml-2 bg-gray-700 hover:bg-gray-800 text-white rounded px-3 py-2 text-sm">Install / Reinstall Shopify
            App</a>
        {% endif %} -->
    </div>
</div>

<div class="bg-white rounded shadow overflow-hidden mb-20">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500"></th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Model</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Brand</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Title</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Stock</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Shopify Link</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Location (Stylia Warehouse)</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Push Error</th>
                <th class="px-4 py-2"></th>
                <th class="px-4 py-2"></th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for p in products %}
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">{{ forloop.counter0|add:products.start_index }}</td>
                <td class="px-4 py-2 font-mono text-sm">{{ p.model_code }}</td>
                <td class="px-4 py-2">{{ p.brand }}</td>
                <td class="px-4 py-2">{{ p.title|default:'—' }}</td>
                <td class="px-4 py-2"><span
                        class="inline-block px-2 py-1 text-xs rounded {% if p.sync_status == 'active' %}bg-green-400 {% elif p.sync_status == 'pending' %}bg-orange-400 {% else %} bg-red-400 {% endif %} text-white">{{p.sync_status}}</span>
                </td>
                <td class="px-4 py-2">{{ p.total_stock }}</td>
                <td class="px-4 py-2">
                    {% if p.shopify_id %}
                    <a class="text-blue-600 hover:underline" target="_blank"
                        href="https://{{ shopify_store_url }}/admin/products/{{ p.shopify_id }}">{{p.shopify_handle|default:p.shopify_id}}</a>
                    {% else %}
                    <span class="text-gray-400">—</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2">
                    {% if p.location_assigned %}
                    <span class="text-green-700 text-xs bg-green-100 px-2 py-1 rounded">Assigned</span>
                    {% elif p.location_last_error %}
                    <span class="text-red-700 text-xs bg-red-100 px-2 py-1 rounded"
                        title="{{ p.location_last_error }}">Error</span>
                    {% else %}
                    <span class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded">Pending</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2">
                    {% if p.push_last_error %}
                    <button onclick="showPushError('{{ p.id }}')"
                        class="text-sm bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1">View
                        ({{p.push_error_count|default:1 }})</button>
                    <div id="push-error-{{ p.id }}" class="hidden">
                        {{ p.push_last_error|escape }}
                    </div>
                    {% else %}
                    <span class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded">—</span>
                    {% endif %}
                </td>
                <td class="px-4 py-2 text-right">
                    {% if p.sync_status == 'deleted' or p.sync_status == 'failed' %}
                    <button onclick="reenable('{{ p.id }}')"
                        class="text-sm bg-green-600 hover:bg-green-700 text-white rounded px-3 py-1">Re-enable</button>
                    {% endif %}
                </td>
                {% if p.sync_status == 'failed' %}
                <td class="px-4 py-2 text-right">
                    <button onclick="deleteProduct('{{ p.id }}')"
                        class="text-sm bg-red-600 hover:bg-red-700 text-white rounded px-3 py-1">Delete</button>
                </td>
                {% endif %}

            </tr>
            {% empty %}
            <tr>
                <td class="px-4 py-6 text-center text-gray-500" colspan="7">No products found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-500">Page {{ products.number }} of {{ products.paginator.num_pages }}</div>
            <div class="space-x-2">
                {% if products.has_previous %}
                <a class="px-3 bg-blue-600 hover:bg-blue-700 text-white py-1 border rounded"
                    href="?show={{ show }}&page={{ products.previous_page_number }}">Prev</a>
                {% endif %}
                {% if products.has_next %}
                <a class="px-3 bg-blue-600 hover:bg-blue-700 text-white py-1 border rounded"
                    href="?show={{ show }}&page={{ products.next_page_number }}">Next</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function onFilterChange() {
        const show = document.getElementById('show').value;
        const url = new URL(window.location.href);
        url.searchParams.set('show', show);
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }

    async function triggerSync() {
        try {
            const res = await fetch('/api/trigger-sync/', { method: 'POST' });
            const data = await res.json();
            alert(data.success ? 'Sync queued: ' + data.task_id : 'Failed: ' + data.error);
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }

    async function reenable(id) {
        if (!confirm('Re-enable this product for syncing?')) return;
        const pushNow = confirm('Do you also want to trigger an immediate sync now?');
        try {
            const res = await fetch(`/api/products/${id}/reenable/${pushNow ? '?push=1' : ''}`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                if (data.pushed_immediately) {
                    alert('Product re-enabled and a sync has been queued (task: ' + data.task_id + ').');
                }
                window.location.reload();
            } else {
                alert('Failed: ' + data.error)
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }

    async function deleteAllPushed() {
        if (!confirm('Delete ALL pushed products from Shopify and the local DB? This is irreversible.')) return;
        try {
            const res = await fetch('/api/delete-all-pushed/', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                alert('Deleted ' + (data.deleted || 0) + ' products.');
                window.location.reload();
            } else {
                alert('Failed: ' + (data.error || JSON.stringify(data.errors || data)));
            }
        } catch (e) {
            alert('Request failed: ' + e.message);
        }
    }
</script>
<!-- Push error modal -->
<div id="pushErrorModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded shadow-lg max-w-2xl w-full mx-4">
        <div class="px-4 py-3 border-b flex items-center justify-between">
            <h3 class="text-lg font-semibold">Push Error</h3>
            <button onclick="closePushError()" class="text-gray-500 hover:text-gray-700">✕</button>
        </div>
        <div class="p-4">
            <pre id="pushErrorContent" class="whitespace-pre-wrap text-sm text-red-700"></pre>
        </div>
        <div class="px-4 py-3 border-t flex justify-end">
            <button onclick="closePushError()" class="px-3 py-1 bg-blue-600 text-white rounded">Close</button>
        </div>
    </div>
</div>

<script>
    function showPushError(id) {
        const container = document.getElementById('push-error-' + id);
        if (!container) return;
        const text = container.textContent || container.innerText || '';
        const modal = document.getElementById('pushErrorModal');
        const content = document.getElementById('pushErrorContent');
        content.textContent = text;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closePushError() {
        const modal = document.getElementById('pushErrorModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
</script>
{% endblock %}